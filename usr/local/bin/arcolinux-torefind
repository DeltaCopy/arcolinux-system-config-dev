#!/bin/bash
#set -e
##################################################################################################################
# Author    : Erik Dubois
# Website   : https://www.erikdubois.be
# Website   : https://www.alci.online
# Website   : https://www.arcolinux.info
# Website   : https://www.arcolinux.com
# Website   : https://www.arcolinuxd.com
# Website   : https://www.arcolinuxb.com
# Website   : https://www.arcolinuxiso.com
# Website   : https://www.arcolinuxforum.com
##################################################################################################################
#
#   DO NOT JUST RUN THIS. EXAMINE AND JUDGE. RUN AT YOUR OWN RISK.
#
##################################################################################################################
#tput setaf 0 = black 
#tput setaf 1 = red 
#tput setaf 2 = green
#tput setaf 3 = yellow 
#tput setaf 4 = dark blue 
#tput setaf 5 = purple
#tput setaf 6 = cyan 
#tput setaf 7 = gray 
#tput setaf 8 = light blue
##################################################################################################################

if lsblk | grep -q "/boot/efi" ; then

	echo "###############################################################################"
	echo "Installing Refind for ArcoLinux"
	echo "###############################################################################"
	echo
	echo "###############################################################################"
	echo "Removing other bootloaders"
	echo "###############################################################################"
	

	is_package_installed() {
	    if pacman -Q "$1" &> /dev/null; then
	        echo "Package $1 is installed."
	        return 0  # Success
	    else
	        echo "Package $1 is not installed."
	        return 1  # Failure
	    fi
	}

	#GRUB GONE
	if is_package_installed arcolinux-bootloader-grub-git; then
	    echo "Removing arcolinux-bootloader-grub-git..."
	    sudo pacman -R arcolinux-bootloader-grub-git --noconfirm
	else
	    echo "Arcolinux-bootloader-grub-git is not installed, no need to remove."
	fi

	if is_package_installed arcolinux-grub-theme-vimix-git; then
	    echo "Removing arcolinux-grub-theme-vimix-git..."
	    sudo pacman -R arcolinux-grub-theme-vimix-git --noconfirm
	else
	    echo "Arcolinux-grub-theme-vimix-git is not installed, no need to remove."
	fi

	#keep last
	if is_package_installed grub; then
	    echo "Removing grub..."
	    sudo pacman -R grub --noconfirm
	else
	    echo "Grub is not installed, no need to remove."
	fi

	if [ -d /boot/grub ]; then
		sudo rm -r /boot/grub
	fi

	if [ -f /etc/default/grub ]; then
		sudo rm /etc/default/grub
	fi

	#SYSTEMD-BOOT GONE
	if is_package_installed kernel-install-mkinitcpio; then
	    echo "Removing kernel-install-mkinitcpio..."
	    sudo pacman -R kernel-install-mkinitcpio --noconfirm
	else
	    echo "Kernel-install-mkinitcpio is not installed, no need to remove."
	fi

	if is_package_installed pacman-hook-kernel-install; then
	    echo "Removing pacman-hook-kernel-install..."
	    sudo pacman -R pacman-hook-kernel-install --noconfirm
	else
	    echo "Pacman-hook-kernel-install is not installed, no need to remove."
	fi

	sudo pacman -S --noconfirm refind
	sudo refind-install
	sudo pacman -S --noconfirm arcolinux-refind-theme-arco-git
	sudo pacman -S --noconfirm arcolinux-bootloader-refind-git

	echo
	echo "###############################################################################"
	echo "###                DONE - YOU CAN CLOSE THIS WINDOW                        ####"
	echo "###############################################################################"

else

	echo
	echo "###############################################################################"
	echo "###                    YOU CAN NOT USE REFIND                              ####"
	echo "###                        KEEP USING GRUB                                 ####"
	echo "###        https://wiki.archlinux.org/title/Arch_boot_process              ####"
	echo "###############################################################################"
fi