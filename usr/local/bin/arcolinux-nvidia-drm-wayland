#!/bin/bash

# Check for each Wayland session file
if [ -f /usr/share/wayland-sessions/hyprland.desktop ] || [ -f /usr/share/wayland-sessions/sway.desktop ] || [ -f /usr/share/wayland-sessions/wayfire.desktop ]; then

	# Just checking if nvidia-dkms is installed else stop
	if pacman -Qi nvidia-dkms &> /dev/null; then
		echo
		echo "################################################################"
		echo "################### Adding option nvidia-drm.modeset=1"
		echo "################################################################"
		echo

		# GRUB
		if [ -f /etc/default/grub ]; then
		    # Check if 'nvidia-drm.modeset=1' is already in the GRUB_CMDLINE_LINUX_DEFAULT line
		    if ! grep -q "nvidia-drm.modeset=1" /etc/default/grub; then
		        # Use sed to append 'nvidia-drm.modeset=1' to the GRUB_CMDLINE_LINUX_DEFAULT line
		        sudo sed -i "/^GRUB_CMDLINE_LINUX_DEFAULT=/ s/\"$/ nvidia-drm.modeset=1\"/" /etc/default/grub
		        echo "Added 'nvidia-drm.modeset=1' to GRUB_CMDLINE_LINUX_DEFAULT in /etc/default/grub"
				grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ArcoLinux
				grub-mkconfig -o /boot/grub/grub.cfg
		    else
		        echo "'nvidia-drm.modeset=1' is already present in /etc/default/grub"
		    fi
		fi

		# SYSTEMD-BOOT
		if [ -d /boot/efi/loader/entries/ ]; then
			ENTRY_DIR="/boot/efi/loader/entries/"
			PARAM="nvidia-drm.modeset=1"

			for entry in "$ENTRY_DIR"*.conf; do
		  	if sudo grep -q "nvidia-drm.modeset=1" "$entry"; then
		    	echo "'nvidia-drm.modeset=1' is already present in $(basename "$entry")"
		  	else
		    	sudo sed -i "/^options / s/options /&$PARAM /" "$entry"
		    	echo "Added parameter to $(basename "$entry")"
		  	fi
			done
		fi

		# REFIND
		# Path to the refind_linux.conf file
		CONF_FILE="/boot/refind_linux.conf"

		# Check if the refind_linux.conf file exists
		if [ -f "$CONF_FILE" ]; then
		    # Check if 'nvidia-drm.modeset=1' is already in the kernel options
		    if grep -q "nvidia-drm.modeset=1" "$CONF_FILE"; then
		        echo "'nvidia-drm.modeset=1' is already present in $CONF_FILE."
		    else
		        # Backup the original configuration file
		        sudo cp "$CONF_FILE" "${CONF_FILE}.bak"

		        # Attempt to add 'nvidia-drm.modeset=1' to the kernel options
		        # The sed command is used to append 'nvidia-drm.modeset=1' right after "rw" but before any other options that may be present.
		        sudo sed -i 's/\(" rw\)\(.*"\)/\1 nvidia-drm.modeset=1\2/' "$CONF_FILE"

		        if [ $? -eq 0 ]; then
		            echo "Successfully added 'nvidia-drm.modeset=1' to the kernel options in $CONF_FILE."
		        else
		            echo "Failed to add 'nvidia-drm.modeset=1' to $CONF_FILE."
		        fi
		    fi
		else
		    echo "$CONF_FILE does not exist."
		fi




	else
		echo "##################################################"
		echo "No nvidia-dkms present - nothing to do"
		echo "##################################################"	
	fi
fi